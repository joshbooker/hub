<!doctype html>
<html lang="">

  <head>
    <meta charset="utf-8">
    <title>ION Tools Console Testing Page</title>

    <style>

      [wrap-text] {
        white-space: pre-line;
        word-break: break-all;
      }

      #generate_jws_form {
        display: none;
      }

      :root[did] #generate_jws_form {
        display: inline-block;
      }

    </style>
  </head>

  <body>
    <H1>ION Tools Console Testing Page</H1>
    <H4>Example did:ion:EiALaq_U-7EHDiAB3wyzqGINaM6bX4WHHRZ2DpKSWClTHg</H4>
    <label for="did_linkedDomain">Linked Domain:</label>
    <input id="did_linkedDomain" />
    <button id="generate_did">Generate Test DID</button>

    <form id="generate_jws_form">
      <label for="jws_payload">JWS Payload:</label>
      <input id="jws_payload" />
      <button id="generate_jws">Generate JWS</button>
    </form>
    <button id="submit_pow">Test submit DID</button></br>
    
    <label for="did_payload">DID Payload:</label>
    <input id="did_payload" />
    <button id="submit_explorer">Test ION Explorer</button>
    <button id="submit_resolver">Test ION Resolver</button>
    <button id="submit_unisolver">Test Universal Resolver</button></br>

 
    <h3>JWS</h3>
    <pre id="print_jws"></pre>

    <h3>Short-Form DID URI</h3>
    <pre id="print_short"></pre>

    <h3>Long-Form DID URI</h3>
    <pre id="print_long" wrap-text></pre>

    <h3>Create DID Request Object</h3>
    <pre id="print_request"></pre>

    <h3>Resolved DID Doc</h3>
    <pre id="print_DIDdoc"></pre>

    <script src="ion.js"></script>
    <script>

      async function generateDID(){
        let serviceEndPoint = did_linkedDomain.value || '';
        let authnKeys = await ION.generateKeyPair();
        return new ION.DID({
          content: {
            publicKeys: [
              {
                id: 'key-1',
                type: 'EcdsaSecp256k1VerificationKey2019',
                publicKeyJwk: authnKeys.publicJwk,
                purposes: [ 'authentication' ]
              }
            ],
            services: [
              {
                id: 'domain-1',
                type: 'LinkedDomains',
                serviceEndpoint: serviceEndPoint
              }
            ]
          }
        });
      };

      JSON.pretty = json => JSON.stringify(json, null, 2)
      let request;
      let did;
      let jws;

      generate_did.addEventListener('click', async e => {
        did = await generateDID();
        document.documentElement.setAttribute('did', await did.getURI('short'))
        print_short.textContent = JSON.pretty(await did.getURI('short'))
        print_long.textContent = JSON.pretty(await did.getURI('long'))

        request = await did.generateRequest(0);
        print_request.textContent = JSON.pretty(request)
      });

      generate_jws_form.addEventListener('submit', async e => {
        e.preventDefault();
        let payload = jws_payload.value || '';
        let key = (await did.getOperation(0)).update.privateJwk;
        jws = await ION.signJws({
          privateJwk: key,
          payload: payload
        });
        jwsDetached = await ION.signJws({
          detached: true,
          privateJwk: key,
          payload: payload
        });
        let valid = await ION.verifyJws({
          publicJwk: key,
          jws: jws
        });
        let validDetached = await ION.verifyJws({
          publicJwk: key,
          jws: jwsDetached,
          payload: payload
        });
        console.log(valid, validDetached);
        console.log(jws, jwsDetached);
        print_jws.textContent = jws;
      })
      submit_pow.addEventListener('click', async () => {
        submit_pow.textContent = "submitting request... look at console to see progress and result"
        await new ION.AnchorRequest(request).submit();
      })
      submit_explorer.addEventListener('click', async () => {
        submit_explorer.textContent = "launching"
        window.open('https://identity.foundation/ion/explorer/?did=' + did_payload.value, '_blank');
      })
      submit_resolver.addEventListener('click', async () => {
        let payload = did_payload.value || '';
        submit_resolver.textContent = "submitting request... look at console to see progress and result"
        const response = await ION.resolve(payload,{nodeEndpoint:'https://beta.discover.did.microsoft.com/1.0/identifiers/'});
        console.log(response);
        print_DIDdoc.textContent = JSON.pretty(response);
      })
      submit_unisolver.addEventListener('click', async () => {
        submit_unisolver.textContent = "launching"
        window.open('https://dev.uniresolver.io/#' + did_payload.value, '_blank');
      })
    </script>
  </body>

</html>
